/*!
 *  opentok-angular (https://github.com/aullman/OpenTok-Angular)
 *  
 *  Angular module for OpenTok
 *
 *  @Author: Adam Ullman (http://github.com/aullman)
 *  @Copyright (c) 2014 Adam Ullman
 *  @License: Released under the MIT license (http://opensource.org/licenses/MIT)
**/
if(!window.TB)throw new Error("You must include the TB library before the TB_Angular library");var OpenTokAngular=angular.module("opentok",[]).factory("TB",function(){return TB}).factory("OTSession",["TB","$rootScope",function(i,e){var s={streams:[],publishers:[],init:function(n,t,o,r){this.session=i.initSession(t),s.session.on({sessionConnected:function(){s.publishers.forEach(function(i){s.session.publish(i)})},streamCreated:function(i){e.$apply(function(){s.streams.push(i.stream)})},streamDestroyed:function(i){e.$apply(function(){s.streams.splice(s.streams.indexOf(i.stream),1)})},sessionDisconnected:function(){e.$apply(function(){s.streams.splice(0,s.streams.length)})}}),this.session.connect(n,o,function(i){r&&r(i,s.session)}),this.trigger("init")}};return i.$.eventing(s),s}]).directive("otLayout",["$window","$parse","TB","OTSession",function(i,e,s,n){return{restrict:"E",link:function(t,o,r){var u=e(r.props)(),c=s.initLayoutContainer(o[0],u);t.$watch(function(){return o.children().length},c.layout),i.addEventListener("resize",c.layout),t.$on("otLayout",c.layout);var h=function(){n.session.on("streamPropertyChanged",function(i){"videoDimensions"===i.changedProperty&&c.layout()})};n.session?h():n.on("init",h)}}}]).directive("otPublisher",["OTSession",function(i){return{restrict:"E",scope:{props:"&"},link:function(e,s,n){var t=e.props()||{};t.width=t.width?t.width:$(s).width(),t.height=t.height?t.height:$(s).height();var o=$(s).children();e.publisher=TB.initPublisher(n.apikey||i.session.apiKey,s[0],t,function(i){i&&e.$emit("otPublisherError",i,e.publisher)}),$(s).append(o),e.publisher.on({accessAllowed:function(){$(s).addClass("allowed")},loaded:function(){e.$emit("otLayout")}}),e.$on("$destroy",function(){i.session?i.session.unpublish(e.publisher):e.publisher.destroy(),i.publishers=i.publishers.filter(function(i){return i!==e.publisher}),e.publisher=null}),i.session&&(i.session.connected||i.session.isConnected&&i.session.isConnected())&&i.session.publish(e.publisher,function(i){i&&e.$emit("otPublisherError",i,e.publisher)}),i.publishers.push(e.publisher)}}}]).directive("otSubscriber",["OTSession",function(i){return{restrict:"E",scope:{stream:"=",props:"&"},link:function(e,s){var n=e.stream,t=e.props()||{};t.width=t.width?t.width:$(s).width(),t.height=t.height?t.height:$(s).height();var o=$(s).children(),r=i.session.subscribe(n,s[0],t,function(i){i&&e.$emit("otSubscriberError",i,r)});r.on("loaded",function(){e.$emit("otLayout")}),$(s).append(o),e.$on("$destroy",function(){i.session.unsubscribe(r)})}}}]);