/*!
 *  opentok-angular (https://github.com/aullman/OpenTok-Angular)
 *
 *  Angular module for OpenTok
 *
 *  @Author: Adam Ullman (http://github.com/aullman)
 *  @Copyright (c) 2014 Adam Ullman
 *  @License: Released under the MIT license (http://opensource.org/licenses/MIT)
**/
if(!window.TB)throw new Error("You must include the TB library before the TB_Angular library");var OpenTokAngular=angular.module("opentok",[]).factory("TB",function(){return TB}).factory("OTSession",["TB","$rootScope",function(e,n){var s={streams:[],publishers:[],init:function(i,t,o,r){this.session=e.initSession(t),s.session.on({sessionConnected:function(){s.publishers.forEach(function(e){s.session.publish(e)})},streamCreated:function(e){n.$apply(function(){s.streams.push(e.stream)})},streamDestroyed:function(e){n.$apply(function(){s.streams.splice(s.streams.indexOf(e.stream),1)})},sessionDisconnected:function(){n.$apply(function(){s.streams.splice(0,s.streams.length)})}}),this.session.connect(i,o,function(e){r&&r(e,s.session)}),this.trigger("init")}};return e.$.eventing(s),s}]).directive("otLayout",["$window","$parse","TB","OTSession",function(e,n,s,i){return{restrict:"E",link:function(t,o,r){var u=n(r.props)(),a=s.initLayoutContainer(o[0],u);t.$watch(function(){return o.children().length},a.layout),e.addEventListener("resize",a.layout),t.$on("otLayout",a.layout);var c=function(){i.session.on("streamPropertyChanged",function(e){"videoDimensions"===e.changedProperty&&a.layout()})};i.session?c():i.on("init",c)}}}]).directive("otPublisher",["OTSession",function(e){return{restrict:"E",scope:{props:"&"},link:function(n,s,i){var t=n.props()||{};t.width=t.width?t.width:angular.element(s).width(),t.height=t.height?t.height:angular.element(s).height();var o=angular.element(s).children();n.publisher=TB.initPublisher(i.apikey||e.session.apiKey,s[0],t,function(e){e&&n.$emit("otPublisherError",e,n.publisher)}),angular.element(s).append(o),n.publisher.on({accessDenied:function(){n.$emit("otAccessDenied")},accessDialogOpened:function(){n.$emit("otAccessDialogOpened")},accessDialogClosed:function(){n.$emit("otAccessDialogClosed")},accessAllowed:function(){angular.element(s).addClass("allowed"),n.$emit("otAccessAllowed")},loaded:function(){n.$emit("otLayout")},streamCreated:function(){n.$emit("otStreamCreated")},streamDestroyed:function(){n.$emit("otStreamDestroyed")}}),n.$on("$destroy",function(){e.session?e.session.unpublish(n.publisher):n.publisher.destroy(),e.publishers=e.publishers.filter(function(e){return e!==n.publisher}),n.publisher=null}),e.session&&(e.session.connected||e.session.isConnected&&e.session.isConnected())&&e.session.publish(n.publisher,function(e){e&&n.$emit("otPublisherError",e,n.publisher)}),e.publishers.push(n.publisher)}}}]).directive("otSubscriber",["OTSession",function(e){return{restrict:"E",scope:{stream:"=",props:"&"},link:function(n,s){var i=n.stream,t=n.props()||{};t.width=t.width?t.width:angular.element(s).width(),t.height=t.height?t.height:angular.element(s).height();var o=angular.element(s).children(),r=e.session.subscribe(i,s[0],t,function(e){e&&n.$emit("otSubscriberError",e,r)});r.on("loaded",function(){n.$emit("otLayout")}),angular.element(s).append(o),n.$on("$destroy",function(){e.session.unsubscribe(r)})}}}]);