/*!
 *  opentok-angular (https://github.com/aullman/OpenTok-Angular)
 *  
 *  Angular module for OpenTok
 *
 *  @Author: Adam Ullman (http://github.com/aullman)
 *  @Copyright (c) 2014 Adam Ullman
 *  @License: Released under the MIT license (http://opensource.org/licenses/MIT)
**/
if(!window.TB)throw new Error("You must include the TB library before the TB_Angular library");angular.module("opentok",[]).factory("TB",function(){return TB}).directive("otSession",["TB",function(e){return{restrict:"E",scope:{apiKey:"@",sessionId:"@",token:"@",session:"=",streams:"=",publisher:"="},link:function(s,n,i){var t=i.apikey,o=i.sessionid,r=i.token;s.streams=[],$(n).addClass("session-disconnected"),s.session=e.initSession(o);var c=function(e){s.$apply(function(){s.streams=s.streams.concat(e)})},a=function(e){for(var n=0;n<e.length;n++)for(var i=0;i<s.streams.length;i++)if(e[n].streamId==s.streams[i].streamId){s.$apply(function(){s.streams.splice(i,1)});break}};s.session.on({sessionConnected:function(e){c(e.streams);var i=angular.element("ot-publisher"),t=s.publisher||i&&i.scope()&&i.scope().publisher;t&&s.session.publish(t),$(n).addClass("session-connected"),$(n).removeClass("session-disconnected"),s.$emit("sessionConnected",e)},streamCreated:function(e){c(e.streams)},streamDestroyed:function(e){a(e.streams)},sessionDisconnected:function(e){s.$apply(function(){s.streams=[]}),$(n).addClass("session-disconnected"),$(n).removeClass("session-connected"),s.$emit("sessionDisconnected",e)}}),s.notMine=function(e){return e.connection.connectionId!=s.session.connection.connectionId},s.session.connect(t,r)}}}]).directive("otLayout",["$window","$parse","TB",function(e,s,n){return{restrict:"E",link:function(i,t,o){var r=s(o.props)(),c=n.initLayoutContainer(t[0],r);i.$watch(function(){return t.children().length},c.layout),e.addEventListener("resize",c.layout),i.$on("otLayout",function(){c.layout()})}}}]).directive("otPublisher",["$document","$window",function(){return{restrict:"E",scope:{props:"&",publisher:"=",session:"="},link:function(e,s,n){var i=e.props()||{};i.width=i.width?i.width:$(s).width(),i.height=i.height?i.height:$(s).height();var t=$(s).children();e.publisher=TB.initPublisher(n.apikey,s[0],i),$(s).append(t),e.publisher.on({accessAllowed:function(){$(s).addClass("allowed")},loaded:function(){e.$emit("otLayout")}}),e.$on("$destroy",function(){e.session?e.session.unpublish(e.publisher):e.publisher.destroy()}),e.session&&e.session.publish(e.publisher)}}}]).directive("otSubscriber",function(){return{restrict:"E",scope:{stream:"=",session:"=",props:"&"},link:function(e,s){var n=e.stream,i=e.session,t=e.props()||{};t.width=t.width?t.width:$(s).width(),t.height=t.height?t.height:$(s).height();var o=$(s).children(),r=i.subscribe(n,s[0],t);r.on("loaded",function(){e.$emit("otLayout")}),$(s).append(o),e.$on("$destroy",function(){r.destroy()})}}});