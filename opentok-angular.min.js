/*!
 *  opentok-angular (https://github.com/aullman/OpenTok-Angular)
 *  
 *  Angular module for OpenTok
 *
 *  @Author: Adam Ullman (http://github.com/aullman)
 *  @Copyright (c) 2014 Adam Ullman
 *  @License: Released under the MIT license (http://opensource.org/licenses/MIT)
**/
if(!window.TB)throw new Error("You must include the TB library before the TB_Angular library");angular.module("opentok",[]).factory("TB",function(){return TB}).directive("otSession",function(s){return{restrict:"E",scope:{apiKey:"@",sessionId:"@",token:"@",session:"=",streams:"=",publisher:"="},link:function(e,n,t){var i=t.apikey,o=t.sessionid,r=t.token;e.streams=[],$(n).addClass("session-disconnected"),e.session=s.initSession(o);var c=function(s){e.$apply(function(){e.streams=e.streams.concat(s)})},a=function(s){for(var n=0;n<s.length;n++)for(var t=0;t<e.streams.length;t++)if(s[n].streamId==e.streams[t].streamId){e.$apply(function(){e.streams.splice(t,1)});break}};e.session.on({sessionConnected:function(s){c(s.streams),e.publisher&&e.session.publish(e.publisher),$(n).addClass("session-connected"),$(n).removeClass("session-disconnected")},streamCreated:function(s){c(s.streams)},streamDestroyed:function(s){a(s.streams)},sessionDisconnected:function(){e.$apply(function(){e.streams=[]}),$(n).addClass("session-disconnected"),$(n).removeClass("session-connected")}}),e.notMine=function(s){return s.connection.connectionId!=e.session.connection.connectionId},e.session.connect(i,r)}}}).directive("otLayout",function(s,e,n){return{restrict:"E",link:function(t,i,o){var r=e(o.props)(),c=n.initLayoutContainer(i[0],r);t.$watch(function(){return i.children().length},c.layout),s.addEventListener("resize",c.layout),t.$on("otLayout",function(){c.layout()})}}}).directive("otPublisher",function(){return{restrict:"E",scope:{props:"&",publisher:"=",session:"="},link:function(s,e,n){var t=s.props()||{};t.width=t.width?t.width:$(e).width(),t.height=t.height?t.height:$(e).height();var i=$(e).children();s.publisher=TB.initPublisher(n.apikey,e[0],t),$(e).append(i),s.publisher.on({accessAllowed:function(){$(e).addClass("allowed")},loaded:function(){s.$emit("otLayout")}}),s.$on("$destroy",function(){s.session?s.session.unpublish(s.publisher):s.publisher.destroy()}),s.session&&s.session.publish(s.publisher)}}}).directive("otSubscriber",function(){return{restrict:"E",scope:{stream:"=",session:"=",props:"&"},link:function(s,e){var n=s.stream,t=s.session,i=s.props()||{};i.width=i.width?i.width:$(e).width(),i.height=i.height?i.height:$(e).height();var o=$(e).children(),r=t.subscribe(n,e[0],i);r.on("loaded",function(){s.$emit("otLayout")}),$(e).append(o),s.$on("$destroy",function(){r.destroy()})}}});