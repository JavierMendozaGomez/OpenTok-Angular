/*!
 *  opentok-angular (https://github.com/aullman/OpenTok-Angular)
 *  
 *  Angular module for OpenTok
 *
 *  @Author: Adam Ullman (http://github.com/aullman)
 *  @Copyright (c) 2014 Adam Ullman
 *  @License: Released under the MIT license (http://opensource.org/licenses/MIT)
**/
if(!window.TB)throw new Error("You must include the TB library before the TB_Angular library");var OpenTokAngular=angular.module("opentok",[]).factory("TB",function(){return TB}).factory("OTSession",["TB","$rootScope","apiKey","sessionId","token",function(e,s,n,i,t){var o={streams:[],session:e.initSession(i),publishers:[]};return o.session.on({sessionConnected:function(){o.publishers.forEach(function(e){o.session.publish(e)})},streamCreated:function(e){s.$apply(function(){o.streams.push(e.stream)})},streamDestroyed:function(e){s.$apply(function(){o.streams.splice(o.streams.indexOf(e.stream),1)})},sessionDisconnected:function(){s.$apply(function(){o.streams.splice(0,o.streams.length-1)})}}),o.session.connect(n,t),o}]).directive("otLayout",["$window","$parse","TB",function(e,s,n){return{restrict:"E",link:function(i,t,o){var r=s(o.props)(),u=n.initLayoutContainer(t[0],r);i.$watch(function(){return t.children().length},u.layout),e.addEventListener("resize",u.layout),i.$on("otLayout",function(){u.layout()})}}}]).directive("otPublisher",["$document","$window","OTSession",function(e,s,n){return{restrict:"E",scope:{props:"&"},link:function(e,s,i){var t=e.props()||{};t.width=t.width?t.width:$(s).width(),t.height=t.height?t.height:$(s).height();var o=$(s).children();e.publisher=TB.initPublisher(i.apikey||n.session.apiKey,s[0],t),$(s).append(o),e.publisher.on({accessAllowed:function(){$(s).addClass("allowed")},loaded:function(){e.$emit("otLayout")}}),e.$on("$destroy",function(){e.session?e.session.unpublish(e.publisher):e.publisher.destroy()}),n.session&&n.session.connected&&n.session.publish(e.publisher),n.publishers.push(e.publisher)}}}]).directive("otSubscriber",["OTSession",function(e){return{restrict:"E",scope:{stream:"=",props:"&"},link:function(s,n){var i=s.stream,t=s.props()||{};t.width=t.width?t.width:$(n).width(),t.height=t.height?t.height:$(n).height();var o=$(n).children(),r=e.session.subscribe(i,n[0],t);r.on("loaded",function(){s.$emit("otLayout")}),$(n).append(o),s.$on("$destroy",function(){r.destroy()})}}}]);